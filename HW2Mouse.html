<!-- 
Assignment 2 - Tic Tac Toe
William Lowrimore
COSC 4345
-->

<html>
  <style type="text/css">
    canvas {
      background: red;
    }
  </style>

  <script id="vertex-shader" type="x-shader/x-vertex">
    attribute vec4 vPos;

    void main()
    {
      gl_PointSize = 1.0;
      gl_Position = vPos;
    }
  </script>

  <script id="fragment-shader" type="x-shader/x-fragment">
    precision mediump float;
    uniform vec4 u_color;

    void main() {
       gl_FragColor = u_color;
    }
  </script>

  <script type="text/javascript" src="webgl-utils.js"></script>
  <script type="text/javascript" src="initshaders.js"></script>
  <script type="text/javascript" src="lines.js"></script>
  <script type="text/javascript" src="circles.js"></script>
  <script type="text/javascript">
    var canvas;
    var gl;
    var colorUniformLocation;
    var pixels = [];
    var points = [];
    var num = 0;
    var p = 0;
    var release = true;

    // Game Board Array
    var board = [
      [null, null, null],
      [null, null, null],
      [null, null, null],
    ];

    window.onload = init;

    function init() {
      canvas = document.getElementById("gl-canvas");
      gl = WebGLUtils.setupWebGL(canvas);
      if (!gl) {
        alert("WebGL isn't available");
      }

      var program = initShaders(gl, "vertex-shader", "fragment-shader");

      var vPos = gl.getAttribLocation(program, "vPos");
      colorUniformLocation = gl.getUniformLocation(program, "u_color");
      var buffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);

      gl.viewport(0, 0, canvas.width, canvas.height);
      // Gray Background
      gl.clearColor(0.9, 0.9, 0.9, 1.0);
      gl.clear(gl.COLOR_BUFFER_BIT);

      gl.useProgram(program);
      gl.enableVertexAttribArray(vPos);
      gl.vertexAttribPointer(vPos, 2, gl.FLOAT, false, 0, 0);

      var vertices = [];
      // Vertical board lines
      vertices = vertices.concat(lineCheck(-300, -900, -300, 900));
      vertices = vertices.concat(lineCheck(300, -900, 300, 900));
      // Horizontal board lines
      vertices = vertices.concat(lineCheck(-900, -300, 900, -300));
      vertices = vertices.concat(lineCheck(-900, 300, 900, 300));

      for (var i = 0; i < vertices.length; i++) {
        pixels[p] = [
          vertices[i][0] / 1000.0,
          vertices[i][1] / 1000.0,
          0.0,
          0.0,
          0.0,
        ];
        points.push(pixels[p][0], pixels[p][1]);
        p++;
      }

      render();
    }

    function render() {
      //On Click
      var mouseDown = function (event) {
        vx = (event.pageX - 250) * 4;
        vy = (250 - event.pageY) * 4;
        // Map the click to a square (col,row); 0, 1, 2
        var col = Math.floor((vx + 900) / 600);
        var row = Math.floor((vy + 900) / 600);
        // Map the click to the center of the square
        var centerX = col * 600 - 600;
        var centerY = row * 600 - 600;

        // Make sure square is empty; left click condition
        if (event.button === 0 && release && board[row][col] === null) {
          var vertices = [];
          // Fill array
          board[row][col] = "X";

          // Pos Line, steep slope (1.5)
          vertices = lineCheck(
            centerX - 100,
            centerY - 150,
            centerX + 100,
            centerY + 150
          );
          // Neg Line, steep slope (-1.5)
          vertices = vertices.concat(
            lineCheck(
              centerX - 100,
              centerY + 150,
              centerX + 100,
              centerY - 150
            )
          );
          for (var i = 0; i < vertices.length; i++) {
            pixels[p] = [
              vertices[i][0] / 1000.0,
              vertices[i][1] / 1000.0,
              // Blue
              0.0,
              0.0,
              1.0,
            ];
            points.push(pixels[p][0], pixels[p][1]);
            p++;
          }
          num++;
          release = false;

          // Make sure square is empty; right click condition
        } else if (event.button === 2 && release && board[row][col] === null) {
          var vertices = [];
          // Fill array
          board[row][col] = "O";

          vertices = drawCircle(150, centerX, centerY);
          for (var i = 0; i < vertices.length; i++) {
            pixels[p] = [
              vertices[i][0] / 1000.0,
              vertices[i][1] / 1000.0,
              // Red
              1.0,
              0.0,
              0.0,
            ];
            points.push(pixels[p][0], pixels[p][1]);
            p++;
          }
          num++;
          release = false;
        }
      };
      canvas.addEventListener("mousedown", mouseDown);

      var mouseUp = function (event) {
        release = true;
      };
      canvas.addEventListener("mouseup", mouseUp);

      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(points), gl.STATIC_DRAW);
      gl.clear(gl.COLOR_BUFFER_BIT);

      for (var i = 0; i < p; i++) {
        gl.uniform4f(
          colorUniformLocation,
          pixels[i][2],
          pixels[i][3],
          pixels[i][4],
          1.0
        );
        gl.drawArrays(gl.POINTS, i, 1);
      }

      requestAnimFrame(render);
    }
  </script>

  <body>
    <canvas id="gl-canvas" width="500" height="500">
      Oops... your browser doesn't support HTML5's Canvas elements!
    </canvas>
  </body>
</html>
